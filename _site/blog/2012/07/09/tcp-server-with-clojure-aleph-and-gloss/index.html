<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>TCP Server with Clojure Aleph and Gloss</title>
  <meta name="description" content="Hi Ho! Its been a long time without writing here. As you might know, I’ve just launched a new web/mobile (Guiato) platform to help retailers reach their cust...">

  <!-- CSS files -->
  <link rel="stylesheet" href="http://localhost:4000/css/font-awesome.min.css">
  <link rel="stylesheet" href="http://localhost:4000/css/main.css">

  <link rel="canonical" href="http://localhost:4000/blog/2012/07/09/tcp-server-with-clojure-aleph-and-gloss/">
  <link rel="alternate" type="application/rss+xml" title="Paulo Suzart" href="http://localhost:4000/feed.xml" />

  <!-- Icons -->
  <!-- 16x16 -->
  <link rel="shortcut icon" href="http://localhost:4000/favicon.ico">
  <!-- 32x32 -->
  <link rel="shortcut icon" href="http://localhost:4000/favicon.png">
</head>


<body>
  <div class="row">
    <div class="col s12 m3">
      <div class="table cover">
        

<div class="cover-card table-cell table-middle">
  
  <a href="http://localhost:4000/" class="author_name">Paulo Suzart</a>
  <span class="author_job">FP and more</span>
  <span class="author_bio mbm">back end developer | machine Learning professional wannabe</span>
  <nav class="nav">
    <ul class="nav-list">
      <li class="nav-item">
        <a href="http://localhost:4000/">home</a>
      </li>
       
        
          <li class="nav-item">
            <a href="http://localhost:4000/archive/">Archive</a>
          </li>
        
          
        
          <li class="nav-item">
            <a href="http://localhost:4000/categories/">Categories</a>
          </li>
        
            
        
          <li class="nav-item">
            <a href="http://localhost:4000/tags/">Tags</a>
          </li>
        
             
    </ul>
  </nav>
  <script type="text/javascript">
  // based on http://stackoverflow.com/a/10300743/280842
  function gen_mail_to_link(hs, subject) {
    var lhs,rhs;
    var p = hs.split('@');
    lhs = p[0];
    rhs = p[1];
    document.write("<a class=\"social-link-item\" target=\"_blank\" href=\"mailto");
    document.write(":" + lhs + "@");
    document.write(rhs + "?subject=" + subject + "\"><i class=\"fa fa-fw fa-envelope\"></i><\/a>");
  }
</script>
<div class="social-links">
  <ul>
    
    
    
    
    <li><a href="http://linkedin.com/in/https://www.linkedin.com/in/paulosuzart/" class="social-link-item" target="_blank"><i class="fa fa-fw fa-linkedin"></i></a></li>
    
    
    
    
    <li><a href="http://github.com/github.com/paulosuzart" class="social-link-item" target="_blank"><i class="fa fa-fw fa-github"></i></a></li>
    
    
    
    
    
    
    
    
    
    
    
    
    
  </ul>
</div>

</div>

      </div>
    </div>
    <div class="col s12 m9">
      <div class="post-listing">
        <a class="btn" href= "http://localhost:4000/" >
  Home
</a>



<div id="post">
  <header class="post-header">
    <h1 title="TCP Server with Clojure Aleph and Gloss">TCP Server with Clojure Aleph and Gloss</h1>
    <span class="post-meta">
      <span class="post-date">
        9 JUL 2012
      </span>
      •
      <span class="read-time" title="Estimated read time">
  
  
    9 mins read
  
</span>

    </span>

  </header>

  <article class="post-content">
    <p>Hi Ho! Its been a long time without writing here. As you might know, I’ve just launched a new web/mobile <a href="http://www.guiato.com.br">(Guiato)</a> platform to help retailers reach their customers with their existing brochures/pamphlets/flyers but now, electronically.</p>

<p>It was as a 4 months adventure, including 20 days in Germany to plan and bring all the platform to Brazil. But now it is time to clojure a bit more. And we are just beginning.
<!--more-->
My team and I have a simple google docs with amazing funny statements - or facts - we say. But it is too much sophisticated, so I decided to write our own system (Clacts) to register and read this facts using <a href="http://clojure.org">Clojure</a>, <a href="https://github.com/ztellman/aleph/wiki">Aleph</a> as TCP server, <a href="https://github.com/ztellman/gloss/wiki">Gloss</a> for encoding/decoding messages and <a href="http://www.sqlite.org/">SQLite</a> for storing facts. Amazing! Isn’t it? :) Well at last it was funny.</p>

<p>I started creating a very simple protocol to allow clients to connect via telnet. So it is:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span>PUT &lt;author&gt; &lt;via&gt; &lt;fact&gt;
LSA &lt;author&gt;<span class="p">|</span>*</code></pre></figure>

<p>We have two main commands, <code>PUT</code> and <code>LSA</code>. For <code>PUT</code>, author is the guy speaking, via is who noted it, and the fact is the statement itself. And for <code>LSA</code> command, you can pass the author’s name and the system will return all the facts spoken by the author. <code>*</code> means you want to read all the facts.</p>

<p>Any other command will be handled as error. Enter Gloss, a lib that allows you to draw how sequence of bytes will be converted to clojure data structures, and how clojure data will be converted to byte sequences. Here is the definition of Clacts the protocol:</p>

<figure class="highlight"><pre><code class="language-clojure" data-lang="clojure"><span></span><span class="p">(</span><span class="k">def </span><span class="nv">p</span> <span class="p">(</span><span class="nf">string</span> <span class="ss">:utf-8</span> <span class="ss">:delimiters</span> <span class="s">&quot; &quot;</span><span class="p">))</span>
<span class="p">(</span><span class="k">def </span><span class="nv">lp</span> <span class="p">(</span><span class="nf">string</span> <span class="ss">:utf-8</span> <span class="ss">:delimiters</span> <span class="p">[</span><span class="s">&quot;\r\n&quot;</span><span class="p">]))</span>

<span class="p">(</span><span class="nf">defcodec</span> <span class="nv">PUTC</span> <span class="p">[</span><span class="s">&quot;PUT&quot;</span> <span class="nv">p</span> <span class="nv">p</span> <span class="nv">lp</span><span class="p">])</span>
<span class="p">(</span><span class="nf">defcodec</span> <span class="nv">LSAC</span> <span class="p">[</span><span class="s">&quot;LSA&quot;</span> <span class="nv">lp</span><span class="p">])</span>
<span class="p">(</span><span class="nf">defcodec</span> <span class="nv">REPC</span> <span class="p">[</span><span class="s">&quot;REP&quot;</span> <span class="nv">lp</span><span class="p">])</span>
<span class="p">(</span><span class="nf">defcodec</span> <span class="nv">LSRC</span> <span class="p">[</span><span class="s">&quot;LSR&quot;</span> <span class="p">(</span><span class="nf">string</span> <span class="ss">:utf-8</span> <span class="ss">:suffix</span> <span class="s">&quot; &quot;</span><span class="p">)</span>
                      <span class="p">(</span><span class="nf">string</span> <span class="ss">:utf-8</span> <span class="ss">:suffix</span> <span class="s">&quot; &quot;</span><span class="p">)</span>
                      <span class="p">(</span><span class="nf">string</span> <span class="ss">:utf-8</span> <span class="ss">:suffix</span> <span class="s">&quot; &quot;</span><span class="p">)</span>
                      <span class="p">(</span><span class="nf">string</span> <span class="ss">:utf-8</span> <span class="ss">:suffix</span> <span class="s">&quot;\r\n&quot;</span><span class="p">)])</span>

<span class="p">(</span><span class="nf">defcodec</span> <span class="nv">ERRC</span> <span class="p">(</span><span class="nf">string</span> <span class="ss">:utf-8</span><span class="p">))</span>

<span class="p">(</span><span class="nf">defcodec</span> <span class="nv">CMDS</span>
  <span class="p">(</span><span class="nf">header</span>
    <span class="nv">p</span>
    <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">h</span><span class="p">]</span> <span class="p">(</span><span class="nf">condp</span> <span class="nb">= </span><span class="nv">h</span>
    	<span class="s">&quot;PUT&quot;</span> <span class="nv">PUTC</span>
    	<span class="s">&quot;LSA&quot;</span> <span class="nv">LSAC</span>
    	<span class="s">&quot;REP&quot;</span> <span class="nv">REPC</span>
    	<span class="s">&quot;LSR&quot;</span> <span class="nv">LSRC</span>
    	<span class="nv">ERRC</span><span class="p">))</span>
    <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">b</span><span class="p">]</span> <span class="p">(</span><span class="nb">first </span><span class="nv">b</span><span class="p">))))</span></code></pre></figure>

<p>Gloss uses the concept of frames and codecs to model your bytes. As a shortcut, i’m using <code>p</code> and <code>lp</code> to identify parameters ended in <code>" "</code> and parameters ended in <code>\r\n</code>. That is, <code>p</code> and <code>lp</code> are frames that will be converted to strings, with UTF-8 encoding.</p>

<p>Given the building block frames <code>p</code> and <code>lp</code> we can start to form the commands. We have <code>PUTC</code>, a codec that is composed by the word <code>PUT</code> plus two <code>p</code> frames and one <code>lp</code> frame. So this: <code>PUT Agustinho Brisola Estou acostumado a criar my propria cloud</code>, will be converted to: <code>["PUT" "Agustinho" "Brisolla" "Estou acostumado a criar minha propria cloud"]</code>. Bang! We have bytes straight to a clojure vector. And testing it is pretty straight forward. Look:</p>

<figure class="highlight"><pre><code class="language-clojure" data-lang="clojure"><span></span><span class="p">(</span><span class="nf">use</span> <span class="ss">&#39;gloss.core</span> <span class="ss">&#39;gloss.io</span><span class="p">)</span>
<span class="p">(</span><span class="nb">import </span><span class="nv">java.nio.ByteBuffer</span><span class="p">)</span>

<span class="p">(</span><span class="k">def </span><span class="nv">buffer</span> <span class="p">(</span><span class="nf">java.nio.ByteBuffer/wrap</span> <span class="p">(</span><span class="nf">.getBytes</span> <span class="s">&quot;PUT Agustinho Brisolla Teste Fact\r\n&quot;</span><span class="p">)))</span>

<span class="p">(</span><span class="nf">decode</span> <span class="nv">PUTC</span> <span class="nv">buffer</span><span class="p">)</span>

<span class="c1">;; [&quot;PUT&quot; &quot;PUT&quot; &quot;Agustinho&quot; &quot;Brisolla Teste Fact&quot;]</span></code></pre></figure>

<p>There are actually more codecs (<code>REPC</code> and <code>LSRC</code>) to handle generic responses and <code>LSA</code> responses respectively. But once you understand the commands, the answers are natural consequences.</p>

<p>Hell yeah! Neat and handy. But clients can actually use different commands, how to understand which command to decode an handle appropriately?</p>

<p>For these cases (and others for sure) Gloss allows you to define a <code>header</code>, which is some part of the frame that behaves as an indicative for the rest of the frames. In this case, look to the codec <code>CMDS</code>. It is composed by a header that, depending on its content, indicates the other commands.</p>

<p>The <code>head</code> function is a bit strange at first, but once you get it, you can go really far. <code>head</code> takes 3 args, <em>(i)</em> its own frame, <em>(ii)</em> a function that given the header it points to the right codec for the rest of the message, and <em>(iii)</em> another function that given the body of a frame, extracts the value of the header. Easy?</p>

<p>Take <code>PUT Agustinho Brisolla Teste Fact\r\n</code> command as an example. <code>PUT</code> is extracted by this <code>string</code> calling <code>frist</code> on it. This is the function that maps the body to header. And given the header, that is a <code>p</code> (the first string separated by space), I check its value and return the appropriate codec: <code>PUTC</code>.</p>

<p>Note the default value for <code>ERRC</code>. This is for the cases where some smart user types an unknown command.</p>

<p>Great, but we have to handle the requests coming from telnet clients. Now it is Aleph time:</p>

<figure class="highlight"><pre><code class="language-clojure" data-lang="clojure"><span></span><span class="p">(</span><span class="kd">defn </span><span class="nv">handler</span>
  <span class="s">&quot;TCP Handler. Decodes the issued command and calls the appropriate</span>
<span class="s">  function to excetion some action.&quot;</span>
  <span class="p">[</span><span class="nv">ch</span> <span class="nv">ci</span><span class="p">]</span>
  <span class="p">(</span><span class="nf">receive-all</span> <span class="nv">ch</span>
    <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">b</span><span class="p">]</span>
      <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">deced</span> <span class="p">(</span><span class="nf">decode</span> <span class="nv">prt/CMDS</span> <span class="nv">b</span><span class="p">)]</span>
        <span class="p">(</span><span class="nb">println </span><span class="s">&quot;Processing command: &quot;</span> <span class="nv">deced</span><span class="p">)</span>
        <span class="p">(</span><span class="nf">condp</span> <span class="nb">= </span><span class="p">(</span><span class="nb">first </span><span class="nv">deced</span><span class="p">)</span>
          <span class="s">&quot;PUT&quot;</span> <span class="p">(</span><span class="nf">put-fact</span> <span class="p">(</span><span class="nb">rest </span><span class="nv">deced</span><span class="p">)</span> <span class="nv">ch</span><span class="p">)</span>
          <span class="s">&quot;LSA&quot;</span> <span class="p">(</span><span class="nf">list-facts</span> <span class="p">(</span><span class="nb">second </span><span class="nv">deced</span><span class="p">)</span> <span class="nv">ch</span><span class="p">)</span>
          <span class="p">(</span><span class="nf">handle-err</span> <span class="nv">ch</span> <span class="nv">ci</span><span class="p">))))))</span>

<span class="p">(</span><span class="nf">start-tcp-server</span> <span class="nv">handler</span> <span class="p">{</span><span class="ss">:port</span> <span class="mi">10000</span><span class="p">})</span></code></pre></figure>

<p>When you start the tcp server without defining the frame to handle, Aleph delivers to the <code>handler</code> a series of <code>ByteBuffers</code>, what is perfect for this case. The handler function decodes the frames against the <code>CMDS</code> codec and calls the correspondent function passing as argument the channel to respond to.</p>

<p>Not that there is a default function - <code>handle-err</code> being called in case of unknown commands. It will respond to clients random error messages.</p>

<p>The functions to list and put facts into the database use the same <code>CMDS</code> codec to encode reply messages. Look:</p>

<figure class="highlight"><pre><code class="language-clojure" data-lang="clojure"><span></span><span class="p">(</span><span class="kd">defn </span><span class="nv">put-fact</span>
  <span class="s">&quot;Inserts the fact into db according to proto/PUTC.</span>
<span class="s">  Takes the decoded data end the channel to respond.&quot;</span>
  <span class="p">[</span><span class="nv">data</span> <span class="nv">ch</span><span class="p">]</span>
  <span class="p">(</span><span class="nf">with-connection</span> <span class="nv">db</span>
    <span class="p">(</span><span class="nf">insert-record</span> <span class="ss">:facts</span>
      <span class="p">{</span><span class="ss">:date</span>   <span class="p">(</span><span class="nb">str </span><span class="p">(</span><span class="nf">System/currentTimeMillis</span><span class="p">))</span>
       <span class="ss">:author</span> <span class="p">(</span><span class="nb">first </span><span class="nv">data</span><span class="p">)</span>
       <span class="ss">:via</span>    <span class="p">(</span><span class="nb">second </span><span class="nv">data</span><span class="p">)</span>
       <span class="ss">:fact</span>   <span class="p">(</span><span class="nb">last </span><span class="nv">data</span><span class="p">)}))</span>
  <span class="p">(</span><span class="nf">enqueue</span> <span class="nv">ch</span> <span class="p">(</span><span class="nf">encode</span> <span class="nv">prt/CMDS</span> <span class="p">[</span><span class="s">&quot;REP&quot;</span> <span class="s">&quot;Fact recorded!! Have fun with it.&quot;</span><span class="p">])))</span></code></pre></figure>

<p><code>REP</code> is a command encoded by <code>REPC</code> codec as defined above. The codec is defined by the header of the message (<code>REP</code>). What is pretty useful and saves your from using <code>if</code> to do that.</p>

<p>You may argue: “Why not use HTTP/Restful thing?” And I say: because this is more fun :)</p>

<p>You can find the full project on my github: <a href="https://github.com/paulosuzart/clact">https://github.com/paulosuzart/clact</a>. There you can see more details regarding interacting with SQLite, that wasn’t covered here.</p>

<h1 id="update-20120803">UPDATE 2012/08/03</h1>
<p>The great brain <a href="http://twitter.com/ztellman">@ztellman</a>, the creator of gloss, gave me a hand <a href="https://github.com/paulosuzart/clact/pull/1">pulling</a> some changes in the code. What he suggested was to specify the frame for the server. So Aleph takes care of the protocol being encoded/decoded and you interact solely with clojure data structures. The change was:</p>

<figure class="highlight"><pre><code class="language-clojure" data-lang="clojure"><span></span><span class="p">(</span><span class="nf">start-tcp-server</span> <span class="nv">handler</span> <span class="p">{</span><span class="ss">:port</span> <span class="p">(</span><span class="ss">:port</span> <span class="nv">opts</span><span class="p">)</span>, <span class="ss">:frame</span> <span class="nv">prt/CMDS</span><span class="p">})</span>

<span class="c1">;;what leads us to check for commands like this:</span>

<span class="p">(</span><span class="nf">receive-all</span> <span class="nv">ch</span>
    <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">cmd</span><span class="p">]</span>
      <span class="p">(</span><span class="nb">println </span><span class="s">&quot;Processing command: &quot;</span> <span class="nv">cmd</span> <span class="s">&quot;From &quot;</span> <span class="nv">ci</span><span class="p">)</span>
      <span class="p">(</span><span class="nf">condp</span> <span class="nb">= </span><span class="p">(</span><span class="nb">first </span><span class="nv">cmd</span><span class="p">)</span>
        <span class="s">&quot;PUT&quot;</span> <span class="p">(</span><span class="nf">put-fact</span> <span class="p">(</span><span class="nb">rest </span><span class="nv">cmd</span><span class="p">)</span> <span class="nv">ch</span><span class="p">)</span>
        <span class="s">&quot;LSA&quot;</span> <span class="p">(</span><span class="nf">list-facts</span> <span class="p">(</span><span class="nb">second </span><span class="nv">cmd</span><span class="p">)</span> <span class="nv">ch</span><span class="p">)</span>
        <span class="p">(</span><span class="nf">handle-err</span> <span class="nv">ch</span> <span class="nv">ci</span><span class="p">)))))</span>

<span class="c1">;; instead of the previous version manually decoding bytes:</span>

<span class="p">(</span><span class="nf">receive-all</span> <span class="nv">ch</span>
  <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">b</span><span class="p">]</span>
    <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">deced</span> <span class="p">(</span><span class="nf">decode</span> <span class="nv">prt/CMDS</span> <span class="nv">b</span><span class="p">)]</span>
      <span class="p">(</span><span class="nb">println </span><span class="s">&quot;Processing command: &quot;</span> <span class="nv">deced</span><span class="p">)</span>
      <span class="p">(</span><span class="nf">condp</span> <span class="nb">= </span><span class="p">(</span><span class="nb">first </span><span class="nv">deced</span><span class="p">)</span>
        <span class="s">&quot;PUT&quot;</span> <span class="p">(</span><span class="nf">put-fact</span> <span class="p">(</span><span class="nb">rest </span><span class="nv">deced</span><span class="p">)</span> <span class="nv">ch</span><span class="p">)</span>
        <span class="s">&quot;LSA&quot;</span> <span class="p">(</span><span class="nf">list-facts</span> <span class="p">(</span><span class="nb">second </span><span class="nv">deced</span><span class="p">)</span> <span class="nv">ch</span><span class="p">)</span>
        <span class="p">(</span><span class="nf">handle-err</span> <span class="nv">ch</span> <span class="nv">ci</span><span class="p">))))))</span>

<span class="c1">;;the same applies for sending response back to the client:</span>

<span class="p">(</span><span class="nf">enqueue</span> <span class="nv">broad-put</span> <span class="p">[</span><span class="s">&quot;REP&quot;</span>
                    <span class="p">(</span><span class="nf">format</span> <span class="s">&quot;####Fact recorded by %s!! By %s: %s.&quot;</span>
                     <span class="nv">via</span> <span class="nv">author</span> <span class="nv">fact</span><span class="p">)]))</span>

<span class="c1">;; no need for manual encoding :)</span></code></pre></figure>

<p>This is great because the best thing on every clojure lib is use pure clojure data structures to keep things uniform.</p>

<p>Thanks to Zach for the precious tips.</p>

  </article>
</div>

<div class="share-buttons">
  <h6>Share on: </h6>
  <ul>
    <li>
      <a href="https://twitter.com/intent/tweet?text=http://localhost:4000/blog/2012/07/09/tcp-server-with-clojure-aleph-and-gloss/" class="twitter btn" title="Share on Twitter"><i class="fa fa-twitter"></i><span> Twitter</span></a>
    </li>
    <li>
      <a href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/blog/2012/07/09/tcp-server-with-clojure-aleph-and-gloss/" class="facebook btn" title="Share on Facebook"><i class="fa fa-facebook"></i><span> Facebook</span></a>
    </li>
    <li>
      <a href="https://plus.google.com/share?url=http://localhost:4000/blog/2012/07/09/tcp-server-with-clojure-aleph-and-gloss/" class="google-plus btn" title="Share on Google Plus"><i class="fa fa-google-plus"></i><span> Google+</span></a>
    </li>
    <li>
      <a href="https://news.ycombinator.com/submitlink?u=http://localhost:4000/blog/2012/07/09/tcp-server-with-clojure-aleph-and-gloss/" class="hacker-news btn" title="Share on Hacker News"><i class="fa fa-hacker-news"></i><span> Hacker News</span></a>
    </li>
    <li>
      <a href="https://www.reddit.com/submit?url=http://localhost:4000/blog/2012/07/09/tcp-server-with-clojure-aleph-and-gloss/" class="reddit btn" title="Share on Reddit"><i class="fa fa-reddit"></i><span> Reddit</span></a>
    </li>
  </ul>
</div><!-- end share-buttons -->


<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'paulosuzartblog';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>



        <footer>
  &copy; 2017 Paulo Suzart. Powered by <a href="http://jekyllrb.com/">Jekyll</a>, <a href="http://github.com/renyuanz/leonids/">leonids theme</a> made with <i class="fa fa-heart heart-icon"></i>
</footer>

      </div>
    </div>
  </div>
  <script type="text/javascript" src="http://localhost:4000/js/jquery-2.1.4.min.js"></script>
<script type="text/javascript" src="http://localhost:4000/js/main.js"></script>

<!-- Asynchronous Google Analytics snippet -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-26676810-1', 'auto');
  ga('send', 'pageview');
</script>


</body>
</html>
