<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
  <link href="http://gmpg.org/xfn/11" rel="profile">

  <title>
    Configuring Clojure Immutant by environment &middot; 
    my blog at github.io
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Open+Sans:300,400italic,400,600,700|Abril+Fatface">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.png">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">


  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-26676810-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>
</head>


  <body>

    <header class="masthead">
      <div class="masthead-inner">
        <h1><a href="/">Paulo Suzart</a></h1>
        <p>I am working with Java platform for the last 10 years. Former SOA architect, now my priority is functional programming (mostly with clojure), virtualization and cloud computing.</p>

        <div class="colophon">
          <ul class="colophon-links">
            <li>
              <a href="https://twitter.com/paulosuzart">@paulosuzart</a>,
            </li>
            <li>
              <a href="https://github.com/paulosuzart">Codes</a>,
            </li>
            <li>
              CTO at <a href="http://www.guiato.com.br" target="_new">Guiato S.A.</a>
            </li>

          </ul>
        </div>
      </div>
    </header>

    <div class="content container">
      <div class="post">
  <h1>Configuring Clojure Immutant by environment</h1>
  <span class="post-date">07 Feb 2013</span>
  <p>Hi again! Not posting for too much long.</p>

<p>Well, this time we will explore the <a href="http://clojure.org">clojure's</a> ability to <a href="http://clojuredocs.org/clojure_core/clojure.core/load-file">load arbitrary files as code</a>.</p>

<p>This is such an amazing feature, but you should be careful. Don't start reading anyones files and evaluating them into your app. Be wise and use it for specific situation like this: I wanted to load a bunch of configurations (and even funtion calls) depending on the environment my app is running.</p>

<p>To do the conditional evaluation, I decided to add an extra key to <code>:immutant</code> entry in my project definition. The entry <code>:env</code> is an <a href="http://immutant.org/documentation/current/initialization.html#sec-3-1">arbitrary configuration value</a>. Lets take a look:</p>

<pre><code class="clojure Silly Project">(defproject tserver "0.1.0-SNAPSHOT"
  :description "A foo project"
  :url "http://foo.com/"
  :license {:name "Eclipse Public License"
            :url "http://www.eclipse.org/legal/epl-v10.html"}
  :dependencies [[org.clojure/clojure "1.4.0"]
                 [compojure "1.0.2"]
                 ;... and many other dependecies
  :jvm-opts ["-Xmx2g" "-server"]
  :immutant {:init "tserver.init/init"} ;; our custo immutant init function
  :profiles {:dev {:immutant {:context-path "/"
                              :nrepl-port 4242
                              :lein-profiles [:dev]
                              :env :dev}}}) ;:dev will identify which config file to load
</code></pre>

<p>In this sample <code>project.clj</code> you find <code>:immutant</code> directly under the project definition. This key is used to, regardless of the environment, inform immutant which funtion to call when your app starts up. In this case <code>tserver.init/init</code>, that we will further analyze.</p>

<p>Pay attention to the <code>:env</code> entry. It is located under <code>:immutant</code> that is under <code>[:profiles :dev]</code>. Here enters a <a href="http://leiningen.org/">leiningen's</a> <a href="https://github.com/technomancy/leiningen/blob/stable/doc/PROFILES.md">profiles feature</a>. Where you can even specify dependencies or anything you want by profile. In this case, the immutant config is being configured by profile.</p>

<p><strong>Why not simply load a config per profile?</strong></p>

<p>Because you can combine <em>n</em> profiles at the sime time. So, which one to use as the enviroment reference? That is why I decided to use an specific entry for that.</p>

<p>Below the initial function being called by immutant. Here goes intereting stuff.
One of them is the use of <a href="http://clojuredocs.org/clojure_core/clojure.core/in-ns"><code>in-ns</code></a>, <a href="http://clojuredocs.org/clojure_core/clojure.core/use"><code>use</code></a> and <a href="http://clojuredocs.org/clojure_core/clojure.core/require"><code>require</code></a>. This is awesome because I'm calling what could be "equivalent to a java import" in the middle of a clojure file, and even better: I'm doing this to another namespace that differs from the code that is actually calling the "imports".</p>

<p>So, <code>in-ns</code> will create the namespace <code>tserver.config</code> and "import" the appropriate functions and namespaces.</p>

<p>The <code>init</code> funtion here will simply call the <code>load-config</code>, that is in charge of loading the config file. Look:</p>

<pre><code class="clojure Silly Project">(ns tserver.init
  (:use [clojure.tools.logging :only (info error debug)]))

(defn setup-config-ns [e]
    (binding [*ns* *ns*]
      (in-ns 'tserver.config)
      (refer-clojure)
      (use '[clojure.main :only (load-script)])
      (require '[immutant.messaging :as msg]
               '[immutant.web :as web]
               '[immutant.util :as util])))

(defn load-config 
  "Attempts to evaluate the specified env file defined by `:env` 
  in the `project.clj`. `:env` is a immutant custom config.
  `:env` MUST be a keyword: Ex.: :dev, :prod :office
  Uses :dev by default.
  Note: The absence of the requrested file will prevent the server to start.
  These siles MUST be located at `src/tserver/config/%s.clj"
  [] 
  (binding [*ns* *ns*]
    (in-ns 'tserver.config)
    (let [ev (get-in (immutant.registry/get :config) [:env] :dev)
            config-file (format "src/tserver/config/%s.clj" (name ev))]
      (setup-config-ns ev)
      (info "Using config file " config-file)
      (load-file config-file)
      (immutant.registry/put :env ev))))

(defn init []
  ;;may do some stuff before
  (load-config)) ;;may do some stuff after
</code></pre>

<p>And finally, our config file containing the required configurations. It can be anything you need.</p>

<pre><code class="clojure Silly Project">(defn handler 
    [r] ((build-routes) r))

(web/start handler
  :reload true)

(msg/start "/queue/delivery.status")

(msg/respond "/queue/delivery.status" handle-delivery-status)

(register-job #'import-job)
(register-job #'check-import)
;register-job is function not provided here
;since the intention is tho show the configuration solution
</code></pre>

<p>Now, to deploy and start the app with the given profile we simply do:</p>

<pre><code class="bash">lein with-profile dev immutant deploy
lein immutant run
</code></pre>

<p>Voila! This will load your <code>dev.clj</code> file and set up your queues, jobs, web-context, whatever you want. This is useful, and I would risk to say mandatory today. You probably have sereval environments where your app resides before going to prodution, and each of them with different names, addresses, pool sizes, queue names, database to connect, etc. And you can easily give to your app the intelligence to load what is more appropriate.</p>

</div>

    <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = "paulosuzartblog"; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/puppet/devops/2014/01/21/my-contribution-to-puppet-forge/">
            My Contribution to Puppet Forge
            <small>21 Jan 2014</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/puppet/advanced/2013/12/15/puppet-good-pattern/">
            Puppet good pattern?
            <small>15 Dec 2013</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/clojure/2013/10/30/understanding-clojure-apply-and-partial/">
            Understanding Clojure apply and partial
            <small>30 Oct 2013</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

    </div>

  </body>
</html>
