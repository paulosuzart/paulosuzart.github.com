
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>TCP Server with Clojure Aleph and Gloss - Paulo Suzart Blog</title>
  <meta name="author" content="Paulo Suzart">

  
  <meta name="description" content="Hi Ho! Its been a long time without writing here. As you might know, I&#8217;ve just launched a new web/mobile (Guiato) platform to help retailers &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://paulosuzart.github.com/blog/2012/07/09/tcp-server-with-clojure-aleph-and-gloss">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Paulo Suzart Blog" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-26676810-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Paulo Suzart Blog</a></h1>
  
    <h2>Functional thoughts.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:paulosuzart.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">TCP Server With Clojure Aleph and Gloss</h1>
    
    
      <p class="meta">
        




  

<time datetime="2012-07-09T11:57:00-03:00" pubdate>Jul 9<span>th</span>, 2012</time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>Hi Ho! Its been a long time without writing here. As you might know, I&#8217;ve just launched a new web/mobile <a href="http://www.guiato.com.br">(Guiato)</a> platform to help retailers reach their customers with their existing brochures/pamphlets/flyers but now, electronically.</p>

<p>It was as a 4 months adventure, including 20 days in Germany to plan and bring all the platform to Brazil. But now it is time to clojure a bit more. And we are just beginning.</p>

<p>My team and I have a simple google docs with amazing funny statements - or facts - we say. But it is too much sophisticated, so I decided to write our own system (Clacts) to register and read this facts using <a href="http://clojure.org">Clojure</a>, <a href="https://github.com/ztellman/aleph/wiki">Aleph</a> as TCP server, <a href="https://github.com/ztellman/gloss/wiki">Gloss</a> for encoding/decoding messages and <a href="http://www.sqlite.org/">SQLite</a> for storing facts. Amazing! Isn&#8217;t it? :) Well at last it was funny.</p>

<p>I started creating a very simple protocol to allow clients to connect via telnet. So it is:</p>

<figure class='code'><figcaption><span>Clacts Protocol</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>PUT &lt;author&gt; &lt;via&gt; &lt;fact&gt;
</span><span class='line'>LSA &lt;author&gt;|*
</span></code></pre></td></tr></table></div></figure>


<p>We have two main commands, <code>PUT</code> and <code>LSA</code>. For <code>PUT</code>, author is the guy speaking, via is who noted it, and the fact is the statement itself. And for <code>LSA</code> command, you can pass the author&#8217;s name and the system will return all the facts spoken by the author. <code>*</code> means you want to read all the facts.</p>

<p>Any other command will be handled as error. Enter Gloss, a lib that allows you to draw how sequence of bytes will be converted to clojure data structures, and how clojure data will be converted to byte sequences. Here is the definition of Clacts the protocol:</p>

<figure class='code'><figcaption><span>Clacts Protocol with Gloss</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">p</span> <span class="p">(</span><span class="nf">string</span> <span class="nv">:utf-8</span> <span class="nv">:delimiters</span> <span class="s">&quot; &quot;</span><span class="p">))</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">lp</span> <span class="p">(</span><span class="nf">string</span> <span class="nv">:utf-8</span> <span class="nv">:delimiters</span> <span class="p">[</span><span class="s">&quot;\r\n&quot;</span><span class="p">]))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">defcodec</span> <span class="nv">PUTC</span> <span class="p">[</span><span class="s">&quot;PUT&quot;</span> <span class="nv">p</span> <span class="nv">p</span> <span class="nv">lp</span><span class="p">])</span>
</span><span class='line'><span class="p">(</span><span class="nf">defcodec</span> <span class="nv">LSAC</span> <span class="p">[</span><span class="s">&quot;LSA&quot;</span> <span class="nv">lp</span><span class="p">])</span>
</span><span class='line'><span class="p">(</span><span class="nf">defcodec</span> <span class="nv">REPC</span> <span class="p">[</span><span class="s">&quot;REP&quot;</span> <span class="nv">lp</span><span class="p">])</span>
</span><span class='line'><span class="p">(</span><span class="nf">defcodec</span> <span class="nv">LSRC</span> <span class="p">[</span><span class="s">&quot;LSR&quot;</span> <span class="p">(</span><span class="nf">string</span> <span class="nv">:utf-8</span> <span class="nv">:suffix</span> <span class="s">&quot; &quot;</span><span class="p">)</span>
</span><span class='line'>                      <span class="p">(</span><span class="nf">string</span> <span class="nv">:utf-8</span> <span class="nv">:suffix</span> <span class="s">&quot; &quot;</span><span class="p">)</span>
</span><span class='line'>                      <span class="p">(</span><span class="nf">string</span> <span class="nv">:utf-8</span> <span class="nv">:suffix</span> <span class="s">&quot; &quot;</span><span class="p">)</span>
</span><span class='line'>                      <span class="p">(</span><span class="nf">string</span> <span class="nv">:utf-8</span> <span class="nv">:suffix</span> <span class="s">&quot;\r\n&quot;</span><span class="p">)])</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">defcodec</span> <span class="nv">ERRC</span> <span class="p">(</span><span class="nf">string</span> <span class="nv">:utf-8</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">defcodec</span> <span class="nv">CMDS</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">header</span>
</span><span class='line'>    <span class="nv">p</span>
</span><span class='line'>    <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">h</span><span class="p">]</span> <span class="p">(</span><span class="nf">condp</span> <span class="nv">=</span> <span class="nv">h</span>
</span><span class='line'>      <span class="s">&quot;PUT&quot;</span> <span class="nv">PUTC</span>
</span><span class='line'>      <span class="s">&quot;LSA&quot;</span> <span class="nv">LSAC</span>
</span><span class='line'>      <span class="s">&quot;REP&quot;</span> <span class="nv">REPC</span>
</span><span class='line'>      <span class="s">&quot;LSR&quot;</span> <span class="nv">LSRC</span>
</span><span class='line'>      <span class="nv">ERRC</span><span class="p">))</span>
</span><span class='line'>    <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">b</span><span class="p">]</span> <span class="p">(</span><span class="nb">first </span><span class="nv">b</span><span class="p">))))</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>Gloss uses the concept of frames and codecs to model your bytes. As a shortcut, i&#8217;m using <code>p</code> and <code>lp</code> to identify parameters ended in <code>" "</code> and parameters ended in <code>\r\n</code>. That is, <code>p</code> and <code>lp</code> are frames that will be converted to strings, with UTF-8 encoding.</p>

<p>Given the building block frames <code>p</code> and <code>lp</code> we can start to form the commands. We have <code>PUTC</code>, a codec that is composed by the word <code>PUT</code> plus two <code>p</code> frames and one <code>lp</code> frame. So this: <code>PUT Agustinho Brisola Estou acostumado a criar my propria cloud</code>, will be converted to: <code>["PUT" "Agustinho" "Brisolla" "Estou acostumado a criar minha propria cloud"]</code>. Bang! We have bytes straight to a clojure vector. And testing it is pretty straight forward. Look:</p>

<figure class='code'><figcaption><span>Testing codecs</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">use</span> <span class="ss">&#39;gloss</span><span class="o">.</span><span class="nv">core</span> <span class="ss">&#39;gloss</span><span class="o">.</span><span class="nv">io</span><span class="p">)</span>
</span><span class='line'><span class="p">(</span><span class="nb">import </span><span class="nv">java</span><span class="o">.</span><span class="nv">nio</span><span class="o">.</span><span class="nv">ByteBuffer</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">buffer</span> <span class="p">(</span><span class="nf">java</span><span class="o">.</span><span class="nv">nio</span><span class="o">.</span><span class="nv">ByteBuffer/wrap</span> <span class="p">(</span><span class="o">.</span><span class="nv">getBytes</span> <span class="s">&quot;PUT Agustinho Brisolla Teste Fact\r\n&quot;</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">decode</span> <span class="nv">PUTC</span> <span class="nv">buffer</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">;; [&quot;PUT&quot; &quot;PUT&quot; &quot;Agustinho&quot; &quot;Brisolla Teste Fact&quot;]</span>
</span></code></pre></td></tr></table></div></figure>


<p>There are actually more codecs (<code>REPC</code> and <code>LSRC</code>) to handle generic responses and <code>LSA</code> responses respectively. But once you understand the commands, the answers are natural consequences.</p>

<p>Hell yeah! Neat and handy. But clients can actually use different commands, how to understand which command to decode an handle appropriately?</p>

<p>For these cases (and others for sure) Gloss allows you to define a <code>header</code>, which is some part of the frame that behaves as an indicative for the rest of the frames. In this case, look to the codec <code>CMDS</code>. It is composed by a header that, depending on its content, indicates the other commands.</p>

<p>The <code>head</code> function is a bit strange at first, but once you get it, you can go really far. <code>head</code> takes 3 args, <em>(i)</em> its own frame, <em>(ii)</em> a function that given the header it points to the right codec for the rest of the message, and <em>(iii)</em> another function that given the body of a frame, extracts the value of the header. Easy?</p>

<p>Take <code>PUT Agustinho Brisolla Teste Fact\r\n</code> command as an example. <code>PUT</code> is extracted by this <code>string</code> calling <code>frist</code> on it. This is the function that maps the body to header. And given the header, that is a <code>p</code> (the first string separated by space), I check its value and return the appropriate codec: <code>PUTC</code>.</p>

<p>Note the default value for <code>ERRC</code>. This is for the cases where some smart user types an unknown command.</p>

<p>Great, but we have to handle the requests coming from telnet clients. Now it is Aleph time:</p>

<figure class='code'><figcaption><span>Aleph TCP Server</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">defn </span><span class="nv">handler</span>
</span><span class='line'>  <span class="s">&quot;TCP Handler. Decodes the issued command and calls the appropriate</span>
</span><span class='line'><span class="s">  function to excetion some action.&quot;</span>
</span><span class='line'>  <span class="p">[</span><span class="nv">ch</span> <span class="nv">ci</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">receive-all</span> <span class="nv">ch</span>
</span><span class='line'>    <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">b</span><span class="p">]</span>
</span><span class='line'>      <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">deced</span> <span class="p">(</span><span class="nf">decode</span> <span class="nv">prt/CMDS</span> <span class="nv">b</span><span class="p">)]</span>
</span><span class='line'>        <span class="p">(</span><span class="nb">println </span><span class="s">&quot;Processing command: &quot;</span> <span class="nv">deced</span><span class="p">)</span>
</span><span class='line'>        <span class="p">(</span><span class="nf">condp</span> <span class="nv">=</span> <span class="p">(</span><span class="nb">first </span><span class="nv">deced</span><span class="p">)</span>
</span><span class='line'>          <span class="s">&quot;PUT&quot;</span> <span class="p">(</span><span class="nf">put-fact</span> <span class="p">(</span><span class="nb">rest </span><span class="nv">deced</span><span class="p">)</span> <span class="nv">ch</span><span class="p">)</span>
</span><span class='line'>          <span class="s">&quot;LSA&quot;</span> <span class="p">(</span><span class="nf">list-facts</span> <span class="p">(</span><span class="nb">second </span><span class="nv">deced</span><span class="p">)</span> <span class="nv">ch</span><span class="p">)</span>
</span><span class='line'>          <span class="p">(</span><span class="nf">handle-err</span> <span class="nv">ch</span> <span class="nv">ci</span><span class="p">))))))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">start-tcp-server</span> <span class="nv">handler</span> <span class="p">{</span><span class="nv">:port</span> <span class="mi">10000</span><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<p>When you start the tcp server without defining the frame to handle, Aleph delivers to the <code>handler</code> a series of <code>ByteBuffers</code>, what is perfect for this case. The handler function decodes the frames against the <code>CMDS</code> codec and calls the correspondent function passing as argument the channel to respond to.</p>

<p>Not that there is a default function - <code>handle-err</code> being called in case of unknown commands. It will respond to clients random error messages.</p>

<p>The functions to list and put facts into the database use the same <code>CMDS</code> codec to encode reply messages. Look:</p>

<figure class='code'><figcaption><span>Inserting facts and replying</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">defn </span><span class="nv">put-fact</span>
</span><span class='line'>  <span class="s">&quot;Inserts the fact into db according to proto/PUTC.</span>
</span><span class='line'><span class="s">  Takes the decoded data end the channel to respond.&quot;</span>
</span><span class='line'>  <span class="p">[</span><span class="nv">data</span> <span class="nv">ch</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">with-connection</span> <span class="nv">db</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">insert-record</span> <span class="nv">:facts</span>
</span><span class='line'>      <span class="p">{</span><span class="nv">:date</span>   <span class="p">(</span><span class="nb">str </span><span class="p">(</span><span class="nf">System/currentTimeMillis</span><span class="p">))</span>
</span><span class='line'>       <span class="nv">:author</span> <span class="p">(</span><span class="nb">first </span><span class="nv">data</span><span class="p">)</span>
</span><span class='line'>       <span class="nv">:via</span>    <span class="p">(</span><span class="nb">second </span><span class="nv">data</span><span class="p">)</span>
</span><span class='line'>       <span class="nv">:fact</span>   <span class="p">(</span><span class="nb">last </span><span class="nv">data</span><span class="p">)}))</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">enqueue</span> <span class="nv">ch</span> <span class="p">(</span><span class="nf">encode</span> <span class="nv">prt/CMDS</span> <span class="p">[</span><span class="s">&quot;REP&quot;</span> <span class="s">&quot;Fact recorded!! Have fun with it.&quot;</span><span class="p">])))</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>REP</code> is a command encoded by <code>REPC</code> codec as defined above. The codec is defined by the header of the message (<code>REP</code>). What is pretty useful and saves your from using <code>if</code> to do that.</p>

<p>You may argue: &#8220;Why not use HTTP/Restful thing?&#8221; And I say: because this is more fun :)</p>

<p>You can find the full project on my github: <a href="https://github.com/paulosuzart/clact">https://github.com/paulosuzart/clact</a>. There you can see more details regarding interacting with SQLite, that wasn&#8217;t covered here.</p>

<h1>UPDATE 2012/08/03</h1>

<p>The great brain <a href="http://twitter.com/ztellman">@ztellman</a>, the creator of gloss, gave me a hand <a href="https://github.com/paulosuzart/clact/pull/1">pulling</a> some changes in the code. What he suggested was to specify the frame for the server. So Aleph takes care of the protocol being encoded/decoded and you interact solely with clojure data structures. The change was:</p>

<figure class='code'><figcaption><span>Zach suggestions</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">start-tcp-server</span> <span class="nv">handler</span> <span class="p">{</span><span class="nv">:port</span> <span class="p">(</span><span class="nf">:port</span> <span class="nv">opts</span><span class="p">)</span><span class="o">,</span> <span class="nv">:frame</span> <span class="nv">prt/CMDS</span><span class="p">})</span>
</span><span class='line'>
</span><span class='line'><span class="c1">;;what leads us to check for commands like this:</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">receive-all</span> <span class="nv">ch</span>
</span><span class='line'>    <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">cmd</span><span class="p">]</span>
</span><span class='line'>      <span class="p">(</span><span class="nb">println </span><span class="s">&quot;Processing command: &quot;</span> <span class="nv">cmd</span> <span class="s">&quot;From &quot;</span> <span class="nv">ci</span><span class="p">)</span>
</span><span class='line'>      <span class="p">(</span><span class="nf">condp</span> <span class="nv">=</span> <span class="p">(</span><span class="nb">first </span><span class="nv">cmd</span><span class="p">)</span>
</span><span class='line'>        <span class="s">&quot;PUT&quot;</span> <span class="p">(</span><span class="nf">put-fact</span> <span class="p">(</span><span class="nb">rest </span><span class="nv">cmd</span><span class="p">)</span> <span class="nv">ch</span><span class="p">)</span>
</span><span class='line'>        <span class="s">&quot;LSA&quot;</span> <span class="p">(</span><span class="nf">list-facts</span> <span class="p">(</span><span class="nb">second </span><span class="nv">cmd</span><span class="p">)</span> <span class="nv">ch</span><span class="p">)</span>
</span><span class='line'>        <span class="p">(</span><span class="nf">handle-err</span> <span class="nv">ch</span> <span class="nv">ci</span><span class="p">)))))</span>
</span><span class='line'>
</span><span class='line'><span class="c1">;; instead of the previous version manually decoding bytes:</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">receive-all</span> <span class="nv">ch</span>
</span><span class='line'>  <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">b</span><span class="p">]</span>
</span><span class='line'>    <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">deced</span> <span class="p">(</span><span class="nf">decode</span> <span class="nv">prt/CMDS</span> <span class="nv">b</span><span class="p">)]</span>
</span><span class='line'>      <span class="p">(</span><span class="nb">println </span><span class="s">&quot;Processing command: &quot;</span> <span class="nv">deced</span><span class="p">)</span>
</span><span class='line'>      <span class="p">(</span><span class="nf">condp</span> <span class="nv">=</span> <span class="p">(</span><span class="nb">first </span><span class="nv">deced</span><span class="p">)</span>
</span><span class='line'>        <span class="s">&quot;PUT&quot;</span> <span class="p">(</span><span class="nf">put-fact</span> <span class="p">(</span><span class="nb">rest </span><span class="nv">deced</span><span class="p">)</span> <span class="nv">ch</span><span class="p">)</span>
</span><span class='line'>        <span class="s">&quot;LSA&quot;</span> <span class="p">(</span><span class="nf">list-facts</span> <span class="p">(</span><span class="nb">second </span><span class="nv">deced</span><span class="p">)</span> <span class="nv">ch</span><span class="p">)</span>
</span><span class='line'>        <span class="p">(</span><span class="nf">handle-err</span> <span class="nv">ch</span> <span class="nv">ci</span><span class="p">))))))</span>
</span><span class='line'>
</span><span class='line'><span class="c1">;;the same applies for sending response back to the client:</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">enqueue</span> <span class="nv">broad-put</span> <span class="p">[</span><span class="s">&quot;REP&quot;</span>
</span><span class='line'>                    <span class="p">(</span><span class="nf">format</span> <span class="s">&quot;####Fact recorded by %s!! By %s: %s.&quot;</span>
</span><span class='line'>                     <span class="nv">via</span> <span class="nv">author</span> <span class="nv">fact</span><span class="p">)]))</span>
</span><span class='line'>
</span><span class='line'><span class="c1">;; no need for manual encoding :)</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is great because the best thing on every clojure lib is use pure clojure data structures to keep things uniform.</p>

<p>Thanks to Zach for the precious tips.</p>

<p>Don&#8217;t forget to visit the <a href="/about">about</a> page. And follow me on Twitter: <a href="http://twitter.com/paulosuzart">@paulosuzart</a>.</p>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Paulo Suzart</span></span>

      




  

<time datetime="2012-07-09T11:57:00-03:00" pubdate>Jul 9<span>th</span>, 2012</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/clojure/'>clojure</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://paulosuzart.github.com/blog/2012/07/09/tcp-server-with-clojure-aleph-and-gloss/" data-via="paulosuzart" data-counturl="http://paulosuzart.github.com/blog/2012/07/09/tcp-server-with-clojure-aleph-and-gloss/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2012/04/17/monitoring-ec2-with-clojure-and-server-stats/" title="Previous Post: Monitoring ec2 with clojure and Server-Stats">&laquo; Monitoring ec2 with clojure and Server-Stats</a>
      
      
        <a class="basic-alignment right" href="/blog/2013/02/07/configuring-clojure-immutant-by-environment/" title="next Post: Configuring Clojure Immutant by environment">Configuring Clojure Immutant by environment &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/09/20/ultrafast-web-development-with-perl-plus-bootstrap-plus-mongodb/">Ultrafast web development with Perl + Bootstrap + MongoDB</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/08/26/geocoding-csvs-with-clojure/">Geocoding CSVs with Clojure</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/08/21/docker-plus-ansible/">Docker + Ansible</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/05/20/janus-plus-ack-grep-plus-fish-shell-tools-to-rule-everything/">Janus + ack-grep + fish shell: Tools to rule everything</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/02/07/configuring-clojure-immutant-by-environment/">Configuring Clojure Immutant by environment</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>Github Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/paulosuzart">@paulosuzart</a> on Github
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'paulosuzart',
            count: 5,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("paulosuzart", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/paulosuzart" class="twitter-follow-button" data-width="208px" data-show-count="false">Follow @paulosuzart</a>
  
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Paulo Suzart -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'paulosuzartblog';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://paulosuzart.github.com/blog/2012/07/09/tcp-server-with-clojure-aleph-and-gloss';
        var disqus_url = 'http://paulosuzart.github.com/blog/2012/07/09/tcp-server-with-clojure-aleph-and-gloss';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
