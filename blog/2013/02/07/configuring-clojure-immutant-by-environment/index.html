<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
  <link href="http://gmpg.org/xfn/11" rel="profile">

  <title>
    Configuring Clojure Immutant by environment &middot; 
    my blog at github.io
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Open+Sans:300,400italic,400,600,700|Abril+Fatface">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.png">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">


  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-26676810-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>
</head>


  <body>

    <header class="masthead">
      <div class="masthead-inner">
        <h1><a href="/">Paulo Suzart</a></h1>
        <p>Functional programming (mostly with clojure), virtualization and cloud computing.</p>

        <div class="colophon">
          <ul class="colophon-links">
            <li>
              <a href="https://github.com/paulosuzart">Codes</a>,
            </li>
          </ul>
        </div>
      </div>
    </header>

    <div class="content container">
      <div class="post">
  <h1>Configuring Clojure Immutant by environment</h1>
  <span class="post-date">07 Feb 2013</span>
  <p>Hi again! Not posting for too much long.</p>

<p>Well, this time we will explore the <a href="http://clojure.org">clojure’s</a> ability to <a href="http://clojuredocs.org/clojure_core/clojure.core/load-file">load arbitrary files as code</a>.</p>

<p>This is such an amazing feature, but you should be careful. Don’t start reading anyones files and evaluating them into your app. Be wise and use it for specific situation like this: I wanted to load a bunch of configurations (and even funtion calls) depending on the environment my app is running.</p>

<p>To do the conditional evaluation, I decided to add an extra key to <code>:immutant</code> entry in my project definition. The entry <code>:env</code> is an <a href="http://immutant.org/documentation/current/initialization.html#sec-3-1">arbitrary configuration value</a>. Lets take a look:</p>

<div class="highlight"><pre><code class="language-clojure" data-lang="clojure"><span class="p">(</span><span class="kd">defproject </span><span class="nv">tserver</span> <span class="s">&quot;0.1.0-SNAPSHOT&quot;</span>
  <span class="ss">:description</span> <span class="s">&quot;A foo project&quot;</span>
  <span class="ss">:url</span> <span class="s">&quot;http://foo.com/&quot;</span>
  <span class="ss">:license</span> <span class="p">{</span><span class="ss">:name</span> <span class="s">&quot;Eclipse Public License&quot;</span>
            <span class="ss">:url</span> <span class="s">&quot;http://www.eclipse.org/legal/epl-v10.html&quot;</span><span class="p">}</span>
  <span class="ss">:dependencies</span> <span class="p">[[</span><span class="nv">org.clojure/clojure</span> <span class="s">&quot;1.4.0&quot;</span><span class="p">]</span>
                 <span class="p">[</span><span class="nv">compojure</span> <span class="s">&quot;1.0.2&quot;</span><span class="p">]</span>
                 <span class="c1">;... and many other dependecies</span>
  <span class="ss">:jvm-opts</span> <span class="p">[</span><span class="s">&quot;-Xmx2g&quot;</span> <span class="s">&quot;-server&quot;</span><span class="p">]</span>
  <span class="ss">:immutant</span> <span class="p">{</span><span class="ss">:init</span> <span class="s">&quot;tserver.init/init&quot;</span><span class="p">}</span> <span class="c1">;; our custo immutant init function</span>
  <span class="ss">:profiles</span> <span class="p">{</span><span class="ss">:dev</span> <span class="p">{</span><span class="ss">:immutant</span> <span class="p">{</span><span class="ss">:context-path</span> <span class="s">&quot;/&quot;</span>
                              <span class="ss">:nrepl-port</span> <span class="mi">4242</span>
                              <span class="ss">:lein-profiles</span> <span class="p">[</span><span class="ss">:dev</span><span class="p">]</span>
                              <span class="ss">:env</span> <span class="ss">:dev</span><span class="p">}}})</span> <span class="c1">;:dev will identify which config file to load</span></code></pre></div>

<p>In this sample <code>project.clj</code> you find <code>:immutant</code> directly under the project definition. This key is used to, regardless of the environment, inform immutant which funtion to call when your app starts up. In this case <code>tserver.init/init</code>, that we will further analyze.</p>

<p>Pay attention to the <code>:env</code> entry. It is located under <code>:immutant</code> that is under <code>[:profiles :dev]</code>. Here enters a <a href="http://leiningen.org/">leiningen’s</a> <a href="https://github.com/technomancy/leiningen/blob/stable/doc/PROFILES.md">profiles feature</a>. Where you can even specify dependencies or anything you want by profile. In this case, the immutant config is being configured by profile.</p>

<p><strong>Why not simply load a config per profile?</strong></p>

<p>Because you can combine <em>n</em> profiles at the sime time. So, which one to use as the enviroment reference? That is why I decided to use an specific entry for that.</p>

<p>Below the initial function being called by immutant. Here goes intereting stuff.
One of them is the use of <a href="http://clojuredocs.org/clojure_core/clojure.core/in-ns"><code>in-ns</code></a>, <a href="http://clojuredocs.org/clojure_core/clojure.core/use"><code>use</code></a> and <a href="http://clojuredocs.org/clojure_core/clojure.core/require"><code>require</code></a>. This is awesome because I’m calling what could be “equivalent to a java import” in the middle of a clojure file, and even better: I’m doing this to another namespace that differs from the code that is actually calling the “imports”.</p>

<p>So, <code>in-ns</code> will create the namespace <code>tserver.config</code> and “import” the appropriate functions and namespaces.</p>

<p>The <code>init</code> funtion here will simply call the <code>load-config</code>, that is in charge of loading the config file. Look:</p>

<div class="highlight"><pre><code class="language-clojure" data-lang="clojure"><span class="p">(</span><span class="kd">ns </span><span class="nv">tserver.init</span>
  <span class="p">(</span><span class="ss">:use</span> <span class="p">[</span><span class="nv">clojure.tools.logging</span> <span class="ss">:only</span> <span class="p">(</span><span class="nf">info</span> <span class="nv">error</span> <span class="nv">debug</span><span class="p">)]))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">setup-config-ns</span> <span class="p">[</span><span class="nv">e</span><span class="p">]</span>
	<span class="p">(</span><span class="nb">binding </span><span class="p">[</span><span class="nv">*ns*</span> <span class="nv">*ns*</span><span class="p">]</span>
      <span class="p">(</span><span class="nb">in-ns </span><span class="ss">&#39;tserver.config</span><span class="p">)</span>
      <span class="p">(</span><span class="nf">refer-clojure</span><span class="p">)</span>
      <span class="p">(</span><span class="nf">use</span> <span class="o">&#39;</span><span class="p">[</span><span class="nv">clojure.main</span> <span class="ss">:only</span> <span class="p">(</span><span class="nf">load-script</span><span class="p">)])</span>
      <span class="p">(</span><span class="nf">require</span> <span class="o">&#39;</span><span class="p">[</span><span class="nv">immutant.messaging</span> <span class="ss">:as</span> <span class="nv">msg</span><span class="p">]</span>
               <span class="o">&#39;</span><span class="p">[</span><span class="nv">immutant.web</span> <span class="ss">:as</span> <span class="nv">web</span><span class="p">]</span>
               <span class="o">&#39;</span><span class="p">[</span><span class="nv">immutant.util</span> <span class="ss">:as</span> <span class="nv">util</span><span class="p">])))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">load-config</span>
  <span class="s">&quot;Attempts to evaluate the specified env file defined by `:env`</span>
<span class="s">  in the `project.clj`. `:env` is a immutant custom config.</span>
<span class="s">  `:env` MUST be a keyword: Ex.: :dev, :prod :office</span>
<span class="s">  Uses :dev by default.</span>
<span class="s">  Note: The absence of the requrested file will prevent the server to start.</span>
<span class="s">  These siles MUST be located at `src/tserver/config/%s.clj&quot;</span>
  <span class="p">[]</span>
  <span class="p">(</span><span class="nb">binding </span><span class="p">[</span><span class="nv">*ns*</span> <span class="nv">*ns*</span><span class="p">]</span>
    <span class="p">(</span><span class="nb">in-ns </span><span class="ss">&#39;tserver.config</span><span class="p">)</span>
    <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">ev</span> <span class="p">(</span><span class="nf">get-in</span> <span class="p">(</span><span class="nf">immutant.registry/get</span> <span class="ss">:config</span><span class="p">)</span> <span class="p">[</span><span class="ss">:env</span><span class="p">]</span> <span class="ss">:dev</span><span class="p">)</span>
    	    <span class="nv">config-file</span> <span class="p">(</span><span class="nf">format</span> <span class="s">&quot;src/tserver/config/%s.clj&quot;</span> <span class="p">(</span><span class="nb">name </span><span class="nv">ev</span><span class="p">))]</span>
  	  <span class="p">(</span><span class="nf">setup-config-ns</span> <span class="nv">ev</span><span class="p">)</span>
      <span class="p">(</span><span class="nf">info</span> <span class="s">&quot;Using config file &quot;</span> <span class="nv">config-file</span><span class="p">)</span>
  	  <span class="p">(</span><span class="nb">load-file </span><span class="nv">config-file</span><span class="p">)</span>
  	  <span class="p">(</span><span class="nf">immutant.registry/put</span> <span class="ss">:env</span> <span class="nv">ev</span><span class="p">))))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">init</span> <span class="p">[]</span>
  <span class="c1">;;may do some stuff before</span>
  <span class="p">(</span><span class="nf">load-config</span><span class="p">))</span> <span class="c1">;;may do some stuff after</span></code></pre></div>

<p>And finally, our config file containing the required configurations. It can be anything you need.</p>

<div class="highlight"><pre><code class="language-clojure" data-lang="clojure"><span class="p">(</span><span class="kd">defn </span><span class="nv">handler</span>
    <span class="p">[</span><span class="nv">r</span><span class="p">]</span> <span class="p">((</span><span class="nf">build-routes</span><span class="p">)</span> <span class="nv">r</span><span class="p">))</span>

<span class="p">(</span><span class="nf">web/start</span> <span class="nv">handler</span>
  <span class="ss">:reload</span> <span class="nv">true</span><span class="p">)</span>

<span class="p">(</span><span class="nf">msg/start</span> <span class="s">&quot;/queue/delivery.status&quot;</span><span class="p">)</span>

<span class="p">(</span><span class="nf">msg/respond</span> <span class="s">&quot;/queue/delivery.status&quot;</span> <span class="nv">handle-delivery-status</span><span class="p">)</span>

<span class="p">(</span><span class="nf">register-job</span> <span class="o">#</span><span class="ss">&#39;import-job</span><span class="p">)</span>
<span class="p">(</span><span class="nf">register-job</span> <span class="o">#</span><span class="ss">&#39;check-import</span><span class="p">)</span>
<span class="c1">;register-job is function not provided here</span>
<span class="c1">;since the intention is tho show the configuration solution</span></code></pre></div>

<p>Now, to deploy and start the app with the given profile we simply do:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">lein with-profile dev immutant deploy
lein immutant run</code></pre></div>

<p>Voila! This will load your <code>dev.clj</code> file and set up your queues, jobs, web-context, whatever you want. This is useful, and I would risk to say mandatory today. You probably have sereval environments where your app resides before going to prodution, and each of them with different names, addresses, pool sizes, queue names, database to connect, etc. And you can easily give to your app the intelligence to load what is more appropriate.</p>

</div>

    <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = "paulosuzartblog"; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/blog/2015/09/23/database-functional-mapping-with-slick/">
            Database Functional Mapping with Slick
            <small>23 Sep 2015</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/blog/2015/08/21/how-much-functional-are-you/">
            How Much Functional Are You?
            <small>21 Aug 2015</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/blog/2015/05/30/give-kotlin-and-quasar-a-try/">
            Give Kotlin And Quasar a Try
            <small>30 May 2015</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

    </div>

  </body>
</html>
