
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Korma and clojure records - Paulo Suzart Blog</title>
  <meta name="author" content="Paulo Suzart">

  
  <meta name="description" content="Korma is a clojure framework (by @ibdknox) that provides great SQL abstractions. You can work purely with clojure code without inserting SQL strings &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://paulosuzart.github.com/blog/2011/12/04/korma-and-clojure-records">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Paulo Suzart Blog" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-26676810-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Paulo Suzart Blog</a></h1>
  
    <h2>Functional thoughts.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:paulosuzart.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Korma and Clojure Records</h1>
    
    
      <p class="meta">
        




  

<time datetime="2011-12-04T19:02:00-02:00" pubdate>Dec 4<span>th</span>, 2011</time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p><a href="http://sqlkorma.com">Korma</a> is a <a href="http://clojure.org">clojure</a> framework (by <a href="http://twitter.com/ibdknox">@ibdknox</a>) that provides great SQL abstractions. You can work purely with clojure code without inserting SQL strings into your code.</p>

<p>Consider the following entities:</p>

<figure class='code'><figcaption><span>Using defentity </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'> <span class="p">(</span><span class="nf">defdb</span> <span class="nv">mydb</span> <span class="p">(</span><span class="nf">mysql</span>
</span><span class='line'>                     <span class="p">{</span><span class="nv">:port</span> <span class="mi">3306</span>
</span><span class='line'>                       <span class="nv">:host</span> <span class="s">&quot;localhost&quot;</span>
</span><span class='line'>                       <span class="nv">:user</span> <span class="s">&quot;root&quot;</span>
</span><span class='line'>                       <span class="nv">:db</span> <span class="s">&quot;korma_post&quot;</span><span class="p">}))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">defentity</span> <span class="nv">email</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">database</span> <span class="nv">mydb</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">defentity</span> <span class="nv">person</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">has-one</span> <span class="nv">email</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">database</span> <span class="nv">mydb</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>email</code> is the representation of the email table in a mysql database. Note that you don&#8217;t need to specify any fields. It is optional. In this case, both entities will return the column&#8217;s name as map keys in a given select. Let&#8217;s see:</p>

<figure class='code'><figcaption><span>Selecting your data </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nb">select </span><span class="nv">person</span> <span class="p">(</span><span class="nf">with</span> <span class="nv">email</span><span class="p">)))</span>
</span><span class='line'><span class="c1">;;will return</span>
</span><span class='line'><span class="p">[{</span><span class="nv">:id</span> <span class="mi">1</span><span class="o">,</span> <span class="nv">:name</span> <span class="s">&quot;Paulo Suzart&quot;</span><span class="o">,</span>
</span><span class='line'>   <span class="nv">:age</span> <span class="mi">29</span><span class="o">,</span> <span class="nv">:id_2</span> <span class="mi">1</span><span class="nv">x,</span>
</span><span class='line'>   <span class="nv">:email</span> <span class="s">&quot;paulosuzart@gmail.com&quot;</span><span class="o">,</span>
</span><span class='line'>   <span class="nv">:person_id</span> <span class="mi">1</span><span class="p">}</span>
</span><span class='line'> <span class="p">{</span><span class="nv">:id</span> <span class="mi">2</span><span class="o">,</span>
</span><span class='line'>   <span class="nv">:name</span> <span class="s">&quot;Rafael Felini&quot;</span><span class="o">,</span>
</span><span class='line'>   <span class="nv">:age</span> <span class="mi">27</span><span class="o">,</span>
</span><span class='line'>   <span class="nv">:id_2</span> <span class="mi">2</span><span class="o">,</span>
</span><span class='line'>   <span class="nv">:email</span> <span class="s">&quot;rafael.felini@gmail.com&quot;</span><span class="o">,</span>
</span><span class='line'>   <span class="nv">:person_id</span> <span class="mi">2</span><span class="p">}]</span>
</span></code></pre></td></tr></table></div></figure>


<p>The result look like a java Resultset. You can choose the original column names to pass around your application. And since clojure is not type safe or compiled, you may find yourself suffering in cases of database refactories.</p>

<p>A nice solution is to combine Korma <code>entities</code> with <code>transform</code> function and clojure <code>defrecord</code> to get rid of this problem, as well as diminish the surface contact of your code concerned with database access. One solution we (me and <a href="http://twitter.com/rafaelfelini">@rafaelfelini</a>) have found was:</p>

<figure class='code'><figcaption><span>Combining entities with transform and defrecord </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">defrecord</span> <span class="nv">Person</span> <span class="p">[</span><span class="nv">id</span> <span class="nv">name</span> <span class="nv">age</span> <span class="nv">email</span><span class="p">])</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">defentity</span> <span class="nv">person</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">transform</span> <span class="o">#</span><span class="p">(</span><span class="nv">Person</span><span class="o">.</span> <span class="p">(</span><span class="nf">:id</span> <span class="nv">%</span><span class="p">)</span> <span class="p">(</span><span class="nf">:name</span> <span class="nv">%</span><span class="p">)</span> <span class="p">(</span><span class="nf">:age</span> <span class="nv">%</span><span class="p">)</span> <span class="p">(</span><span class="nf">:email</span> <span class="nv">%</span><span class="p">)))</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">has-one</span> <span class="nv">email</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">database</span> <span class="nv">mydb</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="c1">;; now try again</span>
</span><span class='line'><span class="p">(</span><span class="nb">select </span><span class="nv">person</span> <span class="p">(</span><span class="nf">with</span> <span class="nv">email</span><span class="p">)))</span>
</span><span class='line'><span class="c1">;; will return</span>
</span><span class='line'><span class="p">(</span><span class="o">#</span><span class="nv">:user</span><span class="o">.</span><span class="nv">Person</span><span class="p">{</span><span class="nv">:id</span> <span class="mi">1</span><span class="o">,</span>
</span><span class='line'>                         <span class="nv">:name</span> <span class="s">&quot;Paulo Suzart&quot;</span><span class="o">,</span>
</span><span class='line'>                         <span class="nv">:age</span> <span class="mi">29</span><span class="o">,</span>
</span><span class='line'>                         <span class="nv">:email</span> <span class="s">&quot;paulosuzart@gmail.com&quot;</span><span class="p">}</span>
</span><span class='line'> <span class="o">#</span><span class="nv">:user</span><span class="o">.</span><span class="nv">Person</span><span class="p">{</span><span class="nv">:id</span> <span class="mi">2</span><span class="o">,</span>
</span><span class='line'>                         <span class="nv">:name</span> <span class="s">&quot;Rafael Felini&quot;</span><span class="o">,</span>
</span><span class='line'>                         <span class="nv">:age</span> <span class="mi">27</span><span class="o">,</span>
</span><span class='line'>                         <span class="nv">:email</span> <span class="s">&quot;rafael.felini@gmail.com&quot;</span><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <code>transform</code> function takes another function that transforms a database record (with the column names as keys) into a clojure&#8217;s record. In this case <code>Person</code> is the record - that always holds the e-mail. Korma takes care of the join, assuming that the <code>email</code> table has a column called <code>person_id</code>.</p>

<p>Now your code is a bit more resilient to database changes with this thing layer of transformation. Actually a good practice you&#8217;ve done all life as developer.</p>

<p>Korma can do a lot of things to make your life easier, as the abililty to compose queries, and performs really nice. Think I finally found THE framework for relational data access in clojure.</p>

<p>Don&#8217;t forget to visit the <a href="/about">about</a> page. And follow me on Twitter: <a href="http://twitter.com/paulosuzart">@paulosuzart</a>.</p>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Paulo Suzart</span></span>

      




  

<time datetime="2011-12-04T19:02:00-02:00" pubdate>Dec 4<span>th</span>, 2011</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/clojure/'>clojure</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://paulosuzart.github.com/blog/2011/12/04/korma-and-clojure-records/" data-via="paulosuzart" data-counturl="http://paulosuzart.github.com/blog/2011/12/04/korma-and-clojure-records/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2011/10/30/dateparammatcher-for-finagle/" title="Previous Post: DateParamMatcher for Finagle">&laquo; DateParamMatcher for Finagle</a>
      
      
        <a class="basic-alignment right" href="/blog/2011/12/11/my-own-redis-types-notation/" title="next Post: My own REDIS types notation">My own REDIS types notation &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/10/30/understanding-clojure-apply-and-partial/">Understanding Clojure apply and partial</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/09/20/ultrafast-web-development-with-perl-plus-bootstrap-plus-mongodb/">Ultrafast web development with Perl + Bootstrap + MongoDB</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/08/26/geocoding-csvs-with-clojure/">Geocoding CSVs with Clojure</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/08/21/docker-plus-ansible/">Docker + Ansible</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/05/20/janus-plus-ack-grep-plus-fish-shell-tools-to-rule-everything/">Janus + ack-grep + fish shell: Tools to rule everything</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>Github Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/paulosuzart">@paulosuzart</a> on Github
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'paulosuzart',
            count: 5,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("paulosuzart", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/paulosuzart" class="twitter-follow-button" data-width="208px" data-show-count="false">Follow @paulosuzart</a>
  
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Paulo Suzart -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'paulosuzartblog';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://paulosuzart.github.com/blog/2011/12/04/korma-and-clojure-records';
        var disqus_url = 'http://paulosuzart.github.com/blog/2011/12/04/korma-and-clojure-records';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
