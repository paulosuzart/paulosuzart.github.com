<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
  <link href="http://gmpg.org/xfn/11" rel="profile">

  <title>
    Korma and clojure records &middot; 
    my blog at github.io
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Open+Sans:300,400italic,400,600,700|Abril+Fatface">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.png">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">


  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-26676810-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>
</head>


  <body>

    <header class="masthead">
      <div class="masthead-inner">
        <h1><a href="/">Paulo Suzart</a></h1>
        <p>Functional programming (mostly with clojure), virtualization and cloud computing.</p>

        <div class="colophon">
          <ul class="colophon-links">
            <li>
              <a href="https://twitter.com/paulosuzart">@paulosuzart</a>,
            </li>
            <li>
              <a href="https://github.com/paulosuzart">Codes</a>,
            </li>
            <li>
              CTO at <a href="http://www.guiato.com.br" target="_new">Guiato S.A.</a>
            </li>

          </ul>
        </div>
      </div>
    </header>

    <div class="content container">
      <div class="post">
  <h1>Korma and clojure records</h1>
  <span class="post-date">04 Dec 2011</span>
  <p><a href="http://sqlkorma.com">Korma</a> is a <a href="http://clojure.org">clojure</a> framework (by <a href="http://twitter.com/ibdknox">@ibdknox</a>) that provides great SQL abstractions. You can work purely with clojure code without inserting SQL strings into your code.</p>

<p>Consider the following entities:</p>

<p>``` clojure Using defentity</p>

<pre><code> (defdb mydb (mysql 
                     {:port 3306 
                       :host "localhost" 
                       :user "root" 
                       :db "korma_post"}))

(defentity email
    (database mydb))

(defentity person 
    (has-one email)
    (database mydb))
</code></pre>

<p>```</p>

<p><code>email</code> is the representation of the email table in a mysql database. Note that you don't need to specify any fields. It is optional. In this case, both entities will return the column's name as map keys in a given select. Let's see:</p>

<p>``` clojure Selecting your data</p>

<pre><code>(select person (with email)))
;;will return
[{:id 1, :name "Paulo Suzart", 
   :age 29, :id_2 1x, 
   :email "paulosuzart@gmail.com", 
   :person_id 1}
 {:id 2, 
   :name "Rafael Felini", 
   :age 27, 
   :id_2 2, 
   :email "rafael.felini@gmail.com", 
   :person_id 2}]
</code></pre>

<p>```
The result look like a java Resultset. You can choose the original column names to pass around your application. And since clojure is not type safe or compiled, you may find yourself suffering in cases of database refactories.</p>

<p>A nice solution is to combine Korma <code>entities</code> with <code>transform</code> function and clojure <code>defrecord</code> to get rid of this problem, as well as diminish the surface contact of your code concerned with database access. One solution we (me and <a href="http://twitter.com/rafaelfelini">@rafaelfelini</a>) have found was:</p>

<p>``` clojure Combining entities with transform and defrecord</p>

<pre><code>(defrecord Person [id name age email])

(defentity person 
    (transform #(Person. (:id %) (:name %) (:age %) (:email %)))
    (has-one email)
    (database mydb))

;; now try again
(select person (with email)))
;; will return
(#:user.Person{:id 1, 
                         :name "Paulo Suzart", 
                         :age 29, 
                         :email "paulosuzart@gmail.com"} 
 #:user.Person{:id 2, 
                         :name "Rafael Felini", 
                         :age 27, 
                         :email "rafael.felini@gmail.com"})
</code></pre>

<p><code>``
The</code>transform<code>function takes another function that transforms a database record (with the column names as keys) into a clojure's record. In this case</code>Person<code>is the record - that always holds the e-mail. Korma takes care of the join, assuming that the</code>email<code>table has a column called</code>person_id`.</p>

<p>Now your code is a bit more resilient to database changes with this thing layer of transformation. Actually a good practice you've done all life as developer.</p>

<p>Korma can do a lot of things to make your life easier, as the abililty to compose queries, and performs really nice. Think I finally found THE framework for relational data access in clojure.</p>

</div>

    <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = "paulosuzartblog"; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/blog/2014/04/27/sliding-window-events-with-clojure/">
            Sliding Window events with Clojure
            <small>27 Apr 2014</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/blog/2014/01/21/my-contribution-to-puppet-forge/">
            My Contribution to Puppet Forge
            <small>21 Jan 2014</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/blog/2013/12/15/puppet-good-pattern/">
            Puppet good pattern?
            <small>15 Dec 2013</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

    </div>

  </body>
</html>
