<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
  <link href="http://gmpg.org/xfn/11" rel="profile">

  <title>
    Going back to Go (golang) &middot; 
    my blog at github.io
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Open+Sans:300,400italic,400,600,700|Abril+Fatface">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.png">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">


  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-26676810-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>
</head>


  <body>

    <header class="masthead">
      <div class="masthead-inner">
        <h1><a href="/">Paulo Suzart</a></h1>
        <p>Functional programming and a bit of a lot.</p>

        <div class="colophon">
          <ul class="colophon-links">
            <li>
              <a href="https://github.com/paulosuzart">My Github</a>
            </li>
          </ul>
        </div>
      </div>
    </header>

    <div class="content container">
      <div class="post">
  <h1>Going back to Go (golang)</h1>
  <span class="post-date">07 Jul 2014</span>
  <h1 id="intro">Intro</h1>

<p>Hi people, a while ago I made a clear expression of my kinda frustration with clojure ecosystem in the clojure mailling list. I’m not going to share the link here because my post itself was confusing and answers even more.</p>

<p>In summary the furstration comes from TOO TOO TOO MUCH <code>'[ANN]'</code> posts on the list as if it was open source and more specifically, few of them are really bringing value to clojure as other languages have strong libs/tools.</p>

<p>Ok, lets move on. Back in 2011 I wrote a very simple tool called <a href="https://github.com/paulosuzart/gb">gb</a> just for the sake of learning <a href="http://golang.org">Go</a>. In the end it is quite good code and useful if you want to build and use it. It is inspired by <a href="http://httpd.apache.org/docs/2.2/programs/ab.html">Apache Benchmark</a> with less features.</p>

<p>After that, I stopped with Go and went deep in clojure. But the destiny brought me back to Go (I can write about later). I could write a lot about Why Go, but you can find good <a href="http://nathany.com/why-go/">articles</a> and <a href="http://www.gophercon.com/speakers/">videos</a> out there. In summary I would say:</p>

<ul>
  <li>Native clean <a href="http://www.golang-book.com/10/index.htm">concurrency</a> model: Golang routines and channels are amazing abstractions for writing concurrent code, making your brain free to mix and match your logic instead of having it busy with concurrency challenges.</li>
  <li>Pragmatic - Go has no method overloading, no interface implementation keyword (just write the same methods defined in a interface and you are done), no reserved words for public/private/etc (low case for private, upper for public functions and attributes).</li>
  <li><a href="http://spf13.com/post/go-pointers-vs-references">Pointes and references</a> - This will make things even faster with lesser copies between invocations, etc.</li>
  <li>Single binary - No classpath, etc. Build your code in a single binary file with no dependecies. It is just an executable.</li>
  <li>Simple - The language itself is very simple. Easy to understand even if written by others.</li>
  <li>Backed by Google - I used to have more crazy times when I would use anything (including any lib announced in a <code>'[ANN]'</code> post in a mailing list), but it is not sustainable. No maintanance, no support, no clear future are few characteristics of this type of lib. <strong>Share code on Github is not doing open source</strong>. Go is backed by Google, what makes it with longer and responsible life.</li>
  <li>Performance - Golang is super fast. See <a href="http://www.techempower.com/benchmarks/#section=data-r9&amp;hw=peak&amp;test=json&amp;s=2&amp;l=co4&amp;p=3s-0&amp;w=trv3">this comparison</a> for example.</li>
</ul>

<h1 id="what-am-i-doing">What Am I doing?</h1>

<p>I’m writing some kind of tracking system built with [go standard lib](http://golang.org/pkg/, <a href="http://www.gorillatoolkit.org/">Gorilla HTTP Toolkit</a> and <a href="https://github.com/boltdb/bolt">BoltDB</a>. I’ll not share any of my code now, hope I can share the whole tool that is 60% done and evolving fast.</p>

<p>BoltDB is <em>“pure Go key/value store”</em> with the goals of providing <em>“a simple, fast, and reliable database for projects that don’t require a full database server such as Postgres or MySQL”</em>.</p>

<p>I hit BoltDB while learning about <a href="http://codecapsule.com/2012/11/07/ikvs-implementing-a-key-value-store-table-of-contents/">Implementing a Key Value Storate</a>. It is a very interesting topic but I have no time - and possibily no brain - to implement mine. I then went for a simple persistent queue (like (Kestrel)[https://github.com/twitter/kestrel]), but I made the favor to myself of <code>rm -rf</code> my source code folder that had no git. Ok, it is already overtaken :(</p>

<p>These days, <a href="https://twitter.com/boltdb">@BoltDB</a> shared with me a <a href="https://gist.github.com/benbjohnson/91b05a83f6668e3baeab">interesting benchmark</a>:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># Sequentially insert 1M key/value pairs (in 1000 record batches).</span>
<span class="nv">$ </span>bolt bench --count <span class="m">1000000</span> --batch-size 1000
<span class="c"># Write 3.939999671s  (3.939us/op)  (253871 op/sec)</span>
<span class="c"># Read  1.003326413s  (40ns/op) (25000000 op/sec)</span>
 
---------
 
<span class="c"># Randomly insert 1M key/value pairs (in 1000 record batches).</span>
<span class="nv">$ </span>bolt bench --count <span class="m">1000000</span> --batch-size <span class="m">1000</span> --write-mode rnd
<span class="c"># Write 56.84787703s  (56.847us/op) (17591 op/sec)</span>
<span class="c"># Read  1.010560605s  (42ns/op) (23809523 op/sec)</span></code></pre></div>

<p>If in the end can reach half of such throughtput after adding some logic on top fo BoltDB, I’ll many times more than enough.</p>

<p>Just to not have a blog post without code. Lets take a look at sample extracted from real code:</p>

<div class="highlight"><pre><code class="language-go" data-lang="go"><span class="lineno"> 1</span> <span class="kd">type</span> <span class="nx">BoltStorage</span> <span class="kd">struct</span> <span class="p">{</span>
<span class="lineno"> 2</span>   <span class="nx">DB</span>         <span class="o">*</span><span class="nx">bolt</span><span class="p">.</span><span class="nx">DB</span>
<span class="lineno"> 3</span>   <span class="nx">writerChan</span> <span class="kd">chan</span> <span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="kd">interface</span><span class="p">{}</span> <span class="c1">//not so agnostic but enough now</span>
<span class="lineno"> 4</span> <span class="p">}</span>
<span class="lineno"> 5</span> 
<span class="lineno"> 6</span> <span class="kd">func</span> <span class="p">(</span><span class="nx">this</span> <span class="o">*</span><span class="nx">BoltStorage</span><span class="p">)</span> <span class="nx">writer</span><span class="p">()</span> <span class="p">{</span>
<span class="lineno"> 7</span>   <span class="k">for</span> <span class="nx">data</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">this</span><span class="p">.</span><span class="nx">writerChan</span> <span class="p">{</span>
<span class="lineno"> 8</span>     <span class="nx">bucket</span> <span class="o">:=</span> <span class="nx">data</span><span class="p">[</span><span class="mi">0</span><span class="p">].(</span><span class="kt">string</span><span class="p">)</span>
<span class="lineno"> 9</span>     <span class="nx">keyId</span> <span class="o">:=</span> <span class="nx">data</span><span class="p">[</span><span class="mi">1</span><span class="p">].(</span><span class="kt">string</span><span class="p">)</span>
<span class="lineno">10</span>     <span class="nx">dataBytes</span> <span class="o">:=</span> <span class="nx">data</span><span class="p">[</span><span class="mi">2</span><span class="p">].([]</span><span class="kt">byte</span><span class="p">)</span>
<span class="lineno">11</span>     <span class="nx">err</span> <span class="o">:=</span> <span class="nx">this</span><span class="p">.</span><span class="nx">DB</span><span class="p">.</span><span class="nx">Update</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">tx</span> <span class="o">*</span><span class="nx">bolt</span><span class="p">.</span><span class="nx">Tx</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
<span class="lineno">12</span>       <span class="nx">sesionBucket</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">tx</span><span class="p">.</span><span class="nx">CreateBucket</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">bucket</span><span class="p">))</span>
<span class="lineno">13</span>       <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
<span class="lineno">14</span>         <span class="k">return</span> <span class="nx">err</span>
<span class="lineno">15</span>       <span class="p">}</span>
<span class="lineno">16</span>       <span class="k">return</span> <span class="nx">sesionBucket</span><span class="p">.</span><span class="nx">Put</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">keyId</span><span class="p">),</span> <span class="nx">dataBytes</span><span class="p">)</span>
<span class="lineno">17</span>     <span class="p">})</span>
<span class="lineno">18</span>     <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
<span class="lineno">19</span>       <span class="c1">// TODO: Handle instead of panic</span>
<span class="lineno">20</span>       <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="lineno">21</span>     <span class="p">}</span>
<span class="lineno">22</span>   <span class="p">}</span>
<span class="lineno">23</span> <span class="p">}</span>
<span class="lineno">24</span> 
<span class="lineno">25</span> <span class="kd">func</span> <span class="nx">NewBoltStorage</span><span class="p">(</span><span class="nx">dbPath</span> <span class="kt">string</span><span class="p">)</span> <span class="o">*</span><span class="nx">BoltStorage</span> <span class="p">{</span>
<span class="lineno">26</span>   <span class="nx">db</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">bolt</span><span class="p">.</span><span class="nx">Open</span><span class="p">(</span><span class="nx">dbPath</span><span class="p">,</span> <span class="mo">0666</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
<span class="lineno">27</span>   <span class="nx">writerChan</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="kd">interface</span><span class="p">{})</span>
<span class="lineno">28</span>   <span class="nx">boltStorage</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">BoltStorage</span><span class="p">{</span><span class="nx">DB</span><span class="p">:</span> <span class="nx">db</span><span class="p">,</span> <span class="nx">writerChan</span><span class="p">:</span> <span class="nx">writerChan</span><span class="p">}</span>
<span class="lineno">29</span> 
<span class="lineno">30</span>   <span class="k">go</span> <span class="nx">boltStorage</span><span class="p">.</span><span class="nx">writer</span><span class="p">()</span>
<span class="lineno">31</span>   <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
<span class="lineno">32</span>     <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="lineno">33</span>   <span class="p">}</span>
<span class="lineno">34</span>   <span class="k">return</span> <span class="nx">boltStorage</span>
<span class="lineno">35</span> <span class="p">}</span>
<span class="lineno">36</span> 
<span class="lineno">37</span> <span class="c1">// somewhere else</span>
<span class="lineno">38</span> <span class="nx">writerChan</span> <span class="o">&lt;-</span> <span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="kd">interface</span><span class="p">{}{</span><span class="s">&quot;3212123&quot;</span><span class="p">,</span> <span class="s">&quot;1478812031&quot;</span><span class="p">,</span> <span class="nx">data</span><span class="p">}</span></code></pre></div>

<p>Notice that there is a single channel consumed by a go routine. This is the guy that will interact with BoltDB. I’m also using keys that can be ordered while using <code>ForEach</code> to iterate over a Bucket of tracked data.</p>

<p>Notice how simple it is to create a go routine at the line. And even easier it is to create a channel. Not only that, the BoltDB API is straightforward as you can see.</p>

<p>BoltDB organizes data into buckets and then keys and values. An important feature of BoltDB is the transactions. This is a requirement for dealing with multiple insertions (the data itself and any other metadata stored somewhere else).</p>

<p>Ok, hope I can finish this project as soon as possible so I can share more thoughts and lessons learned.</p>

<p>Cheers!</p>


</div>

    <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = "paulosuzartblog"; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/blog/2015/09/23/database-functional-mapping-with-slick/">
            Database Functional Mapping with Slick
            <small>23 Sep 2015</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/blog/2015/08/21/how-much-functional-are-you/">
            How Much Functional Are You?
            <small>21 Aug 2015</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/blog/2015/05/30/give-kotlin-and-quasar-a-try/">
            Give Kotlin And Quasar a Try
            <small>30 May 2015</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

    </div>

  </body>
</html>
